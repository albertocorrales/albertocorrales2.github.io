---           
layout: post
title: How to Setup EventStoreDB on AWS EC2 with Pulumi IaC
date: 2020-11-16 08:08:49 UTC
updated: 2020-11-16 08:08:49 UTC
comments: false
categories: AWS EBS EC2 ESDB eventstore IaC Pulumi
---
<h2 style="text-align: left;"><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-ngTZILTFtKQ/X7FWCi9b6eI/AAAAAAAAGX4/HSFDjF6zSEsbr5VBLtBmztY8ro5-OfaqwCLcBGAsYHQ/s952/header.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="333" data-original-width="952" height="224" src="https://1.bp.blogspot.com/-ngTZILTFtKQ/X7FWCi9b6eI/AAAAAAAAGX4/HSFDjF6zSEsbr5VBLtBmztY8ro5-OfaqwCLcBGAsYHQ/w640-h224/header.png" width="640" /></a></div></h2><h2 style="text-align: left;">Introduction&nbsp;</h2><p>EventStoreDB (ESDB) is an industrial-strength database technology used as the central data store for event-sourced systems. It is available open-source to run locally on most platforms or as SaaS through Event Store Cloud. Currently their SaaS version is under development, so if you want to run it on your cloud, you will have to set it up.</p><p>One option is docker, since ESDB is available as <a href="https://hub.docker.com/r/eventstore/eventstore/">docker image on Docker Hub</a>. However, as <a href="https://github.com/EventStore/eventstore-docker/issues/7">Greg Young explains in this issue</a>, it might be not the best option when it comes to performance, due to the extra virtualization layer. For the same reason, we don't usually use docker images for other database engines like SQL Server, MongoDB, etc.</p><p>Then, if you want to run ESDB on cloud, in particular AWS cloud, EC2 + EBS is the most reasonable option.&nbsp;</p><p>In this post, I would like to share how you can configure ESDB on EC2+EBS easily with Pulumi, which will allow you to automate this process following the best practices.</p><h2 style="text-align: left;">Creating EC2 with Pulumi</h2><p>If you are not familiar with Pulumi, I recommend to start having a look at <a href="https://www.pulumi.com/docs/get-started/aws/">this documentation</a>, where it is explained how to setup a new project for AWS.<br /></p><p>Creating a new EC2 in Pulumi is really straightforward. You just need to define your instance like this:</p><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-84plL3ZvC8U/X7FT8C5KaOI/AAAAAAAAGXs/aBrsiLAbg5YtaAykrPfpF-I__ija2GaKwCLcBGAsYHQ/s683/esdb1.PNG" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="314" data-original-width="683" height="184" src="https://1.bp.blogspot.com/-84plL3ZvC8U/X7FT8C5KaOI/AAAAAAAAGXs/aBrsiLAbg5YtaAykrPfpF-I__ija2GaKwCLcBGAsYHQ/w400-h184/esdb1.PNG" width="400" /></a></div><br /><p>In that code, you can specify the following parameters:</p><ul style="text-align: left;"><li><b>instanceType</b>: type of EC2 instance that you want to use</li><li><b>keyName</b>: key pair that you will use to connect with SSH</li><li><b>ami</b>: AMI you want to use. For example AMI "ami-06fd8a495a537da8b" is to use Ubuntu Server 20.04 LTS</li><li><b>vpcSecurityGroupIds</b>: the security group you are going to use. Here for ESDB you might need to enable ports 1113 and 2113. For SSH you will need to enable port 22.</li><li><b>userData</b>: this is the script to setup ESDB. We will see this more in detail later.</li><li><b>tags</b>: your AWS for this resource. It is highly recommended to tag all your AWS resources with meaningful tags.</li></ul><h2 style="text-align: left;">Setup EventStoreDB on EC2</h2><p>First of all, lets have a look at ESDB config file.</p><div style="background-color: #1e1e1e; color: #d4d4d4; font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; font-weight: normal; line-height: 19px; white-space: pre;"><div><span style="color: #ce9178;">#&nbsp;Paths</span></div><div><span style="color: #ce9178;">Db:&nbsp;/data/eventstore/db</span></div><div><span style="color: #ce9178;">Index:&nbsp;/data/eventstore/index</span></div><div><span style="color: #ce9178;">Log:&nbsp;/data/eventstore/log</span></div><br /><div><span style="color: #ce9178;">#&nbsp;Certificates&nbsp;configuration</span></div><div><span style="color: #ce9178;">CertificateFile:&nbsp;/data/certs/node1/node.crt</span></div><div><span style="color: #ce9178;">CertificatePrivateKeyFile:&nbsp;/data/certs/node1/node.key</span></div><div><span style="color: #ce9178;">TrustedRootCertificatesPath:&nbsp;/data/certs/ca</span></div><br /><div><span style="color: #ce9178;">#&nbsp;Network&nbsp;configuration</span></div><div><span style="color: #ce9178;">HttpPort:&nbsp;2113</span></div><div><span style="color: #ce9178;">ExtTcpPort:&nbsp;1113</span></div><div><span style="color: #ce9178;">EnableExternalTcp:&nbsp;true</span></div><div><span style="color: #ce9178;">EnableAtomPubOverHTTP:&nbsp;true</span></div><br /><div><span style="color: #ce9178;">#&nbsp;Cluster&nbsp;config</span></div><div><span style="color: #ce9178;">ClusterSize:&nbsp;1</span></div><br /><div><span style="color: #ce9178;">#&nbsp;Projections&nbsp;configuration</span></div><div><span style="color: #ce9178;">RunProjections:&nbsp;System</span></div></div><p>If you want to know more about ESDB, I recommend you to visit <a href="https://developers.eventstore.com/server/20.6/server/installation/#quick-start-preview">this guide</a>, which is quite good. Here I normally configure ESDB data and certificates in folder /data, which is in an independent EBS, but I will skip that part in this post, in order to simplify.</p><h3 style="text-align: left;">Now, in our EC2 userData we need to follow these steps:</h3><h3 style="text-align: left;"><span> 1) Install EventStore</span></h3><p><span>In this step we install EventStore repository and we install the latest version, which currently is version 20.6.1. <br /></span></p><div style="background-color: #1e1e1e; color: #d4d4d4; font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; font-weight: normal; line-height: 19px; white-space: pre;"><div><span style="color: #ce9178;">&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Install&nbsp;EventStore</span></div><div><span style="color: #ce9178;">&nbsp;&nbsp;&nbsp;&nbsp;curl&nbsp;-s&nbsp;https://packagecloud.io/install/repositories/EventStore/EventStore-OSS/script.deb.sh&nbsp;|&nbsp;sudo&nbsp;bash</span></div><div><span style="color: #ce9178;">&nbsp;&nbsp;&nbsp;&nbsp;sudo&nbsp;apt-get&nbsp;install&nbsp;eventstore-oss=20.6.1-2</span></div></div><h3 style="text-align: left;"><span>&nbsp; 2) Update EventStore Config</span></h3><p><span>&nbsp;In this step, we overwrite eventstore.conf file with the configuration we saw previously.</span><br /></p><div style="background-color: #1e1e1e; color: #d4d4d4; font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; font-weight: normal; line-height: 19px; white-space: pre;"><div><span style="color: #ce9178;">&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Update&nbsp;EventStore&nbsp;Config</span></div><div><span style="color: #ce9178;">&nbsp;&nbsp;&nbsp;&nbsp;sudo&nbsp;echo&nbsp;"</span><span style="color: #569cd6;">${</span><span style="color: #dcdcaa;">getEventStoreConfig</span><span style="color: #d4d4d4;">()</span><span style="color: #569cd6;">}</span><span style="color: #ce9178;">"&nbsp;&gt;|&nbsp;/etc/eventstore/eventstore.conf</span></div></div><h3 style="text-align: left;">3) Create /data folder and add permissions to eventstore</h3><p>Then, we create folder /data and we assign permissions to eventstore, so the service will be able to own that folder.<br /></p><div style="background-color: #1e1e1e; color: #d4d4d4; font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; font-weight: normal; line-height: 19px; white-space: pre;"><div><span style="color: #ce9178;">&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Create&nbsp;/data&nbsp;folder&nbsp;and&nbsp;add&nbsp;permissions&nbsp;to&nbsp;eventstore</span></div><div><span style="color: #ce9178;">&nbsp;&nbsp;&nbsp;&nbsp;cd&nbsp;/</span></div><div><span style="color: #ce9178;">&nbsp;&nbsp;&nbsp;&nbsp;mkdir&nbsp;data</span></div><div><span style="color: #ce9178;">&nbsp;&nbsp;&nbsp;&nbsp;sudo&nbsp;chown&nbsp;eventstore&nbsp;data</span></div><div><span style="color: #ce9178;">&nbsp;&nbsp;&nbsp;&nbsp;sudo&nbsp;chgrp&nbsp;eventstore&nbsp;data</span></div></div><div><h3 style="text-align: left;">4) Create certificates</h3><p>&nbsp;In this step, we create CA and Node certificates for SSL connection with <a href="https://github.com/EventStore/es-gencert-cli">es-gencert-cli</a>, which is a software created by EventStore to simplify this process. You could also use OpenSSL if you wish.&nbsp; <br /></p><div style="background-color: #1e1e1e; color: #d4d4d4; font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; font-weight: normal; line-height: 19px; white-space: pre;"><div><span style="color: #ce9178;">#&nbsp;Create&nbsp;certificates</span></div><div><span style="color: #ce9178;">&nbsp;&nbsp;&nbsp;&nbsp;cd&nbsp;/data</span></div><div><span style="color: #ce9178;">&nbsp;&nbsp;&nbsp;&nbsp;sudo&nbsp;mkdir&nbsp;certs</span></div><div><span style="color: #ce9178;">&nbsp;&nbsp;&nbsp;&nbsp;cd&nbsp;certs/</span></div><div><span style="color: #ce9178;">&nbsp;&nbsp;&nbsp;&nbsp;sudo&nbsp;wget&nbsp;-c&nbsp;https://github.com/EventStore/es-gencert-cli/releases/download/1.0.2/es-gencert-cli_1.0.2_Linux-x86_64.tar.gz</span></div><div><span style="color: #ce9178;">&nbsp;&nbsp;&nbsp;&nbsp;sudo&nbsp;tar&nbsp;-xzvf&nbsp;es-gencert-cli_1.0.2_Linux-x86_64.tar.gz</span></div><div><span style="color: #ce9178;">&nbsp;&nbsp;&nbsp;&nbsp;sudo&nbsp;./es-gencert-cli&nbsp;create-ca</span></div><div><span style="color: #ce9178;">&nbsp;&nbsp;&nbsp;&nbsp;sudo&nbsp;./es-gencert-cli&nbsp;create-node&nbsp;-out&nbsp;./node1&nbsp;--dns-names&nbsp;*.example.com</span></div><div><span style="color: #ce9178;">&nbsp;&nbsp;&nbsp;&nbsp;find&nbsp;.&nbsp;-type&nbsp;f&nbsp;&nbsp;-name&nbsp;'*.crt'&nbsp;-o&nbsp;-name&nbsp;'*.key'&nbsp;-print0&nbsp;|&nbsp;sudo&nbsp;xargs&nbsp;-0&nbsp;chmod&nbsp;666</span></div></div><h3 style="text-align: left;">5) Run EventStore</h3><p>&nbsp;Finally we enable and start eventstore service.<br /></p><div style="background-color: #1e1e1e; color: #d4d4d4; font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; font-weight: normal; line-height: 19px; white-space: pre;"><div><span style="color: #ce9178;">&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Run&nbsp;EventStore</span></div><div><span style="color: #ce9178;">&nbsp;&nbsp;&nbsp;&nbsp;sudo&nbsp;systemctl&nbsp;enable&nbsp;eventstore</span></div><div><span style="color: #ce9178;">&nbsp;&nbsp;&nbsp;&nbsp;sudo&nbsp;systemctl&nbsp;start&nbsp;eventstore</span></div></div><p>You can find the full example source code on this GitHub repository: <a href="https://github.com/albertocorrales/eventstoredb-aws-ec2">https://github.com/albertocorrales/eventstoredb-aws-ec2</a> <br /></p><p>Conclusions</p><p>In this post, we have seen how we can setup EventStoreDB on AWS EC2 with Pulumi, as IaC framework. If you want to know more about these technologies, I suggest to visit <a href="https://www.eventstore.com/">EventStore documentation</a> and <a href="https://www.pulumi.com/">Pulumi documentation</a>.<br /></p><p><br /></p><p><br /></p></div>