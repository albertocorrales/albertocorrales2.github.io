---           
layout: post
title: AWS assuming role + MFA with pulumi (and other applications)
date: 2021-08-16 21:50:23 UTC
updated: 2021-08-16 21:50:23 UTC
comments: false
categories: 
---
<div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-Bgn9oR5De90/YRrP9H1FIwI/AAAAAAAAGkw/acSGNR5kD60Ohp9BevGkrYwpntQGH9LUwCLcBGAsYHQ/s1146/Page-Illo_Prevent.9a440a3b5794ae42ee42d76dd98f30a7e152629e.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="568" data-original-width="1146" height="259" src="https://1.bp.blogspot.com/-Bgn9oR5De90/YRrP9H1FIwI/AAAAAAAAGkw/acSGNR5kD60Ohp9BevGkrYwpntQGH9LUwCLcBGAsYHQ/w521-h259/Page-Illo_Prevent.9a440a3b5794ae42ee42d76dd98f30a7e152629e.png" width="521" /></a></div><h2 style="text-align: left;">Introduction</h2><p>In AWS, managing your IAM in a centralized account is a good practice, so then you can assume a role to access to other accounts without need of duplicating users. You can find more info about this approach in <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_common-scenarios_aws-accounts.html">this article</a>.</p><p>In addition, for security reasons, it is highly recommended to enable MFA (Multi-factor Authentication), so you need a device to generate a temporary code to get access. In the image below it is showed how assume role with MFA works, but you also have an article about MFA in <a href="https://aws.amazon.com/blogs/security/how-do-i-protect-cross-account-access-using-mfa-2/">this link</a>.</p><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-Lj2Addm2sJ0/YRrQJn5sY6I/AAAAAAAAGk4/DV4-aqjwHtIx6qmAl7YFjOV7NMZRdWXMACLcBGAsYHQ/s997/MFAAPI4.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="560" data-original-width="997" height="360" src="https://1.bp.blogspot.com/-Lj2Addm2sJ0/YRrQJn5sY6I/AAAAAAAAGk4/DV4-aqjwHtIx6qmAl7YFjOV7NMZRdWXMACLcBGAsYHQ/w640-h360/MFAAPI4.png" width="640" /></a></div><div class="separator" style="clear: both; text-align: center;"><br /></div><p>This approach is really useful and most of the configuration can be automated with pulumi (or other providers like terraform or CloudFormation). And once it is configured, you can switch your role and get access to other accounts with a few clicks.&nbsp;</p><p>However, when it comes to external software such us pulumi, getting access assuming a role and using MFA might not be too straightforward. In this article we will see how this can be configured and how we can easily refresh our credentials with a PowerShell script.&nbsp;</p><h2 style="text-align: left;">Getting access with assume role + MFA for pulumi</h2><p>In this section, we will explain how you can setup manually your credentials, so pulumi can get access to your account by assuming a role + using MFA.</p><h3 style="text-align: left;">Getting a token by using MFA</h3><p>First, you need to request temporary MFA credentials, using your AWS Access Key and Secret Key for your user in the account where you have your IAM user. In order to so, you can run this command, which will issue your temporary credentials valid for 8 hours (max 36 hours):</p><p><span style="font-family: courier;">aws sts get-session-token --duration-seconds 28800 --serial-number arn-of-the-mfa-device --token-code code-from-token</span></p><p>Where:</p><p></p><ul style="text-align: left;"><li><i><b>arn-of-the-mfa-device:</b></i> you can find it in AWS Ops account, if you click on your user (top bar), then "My security credentials".</li><li><i><b>from-token</b></i>: numeric code that you can get this code with the app you are using for MFA.</li></ul><p></p><h3 style="text-align: left;">Setup your AWS profile credentials</h3><p>Then, you need to&nbsp; add two profiles. One to setup your temporary credentials and another to assume the role for the account that you want to get access.&nbsp;</p><p>In order to setup to setup these profiles, you have to go to C:\Users\YourUser\.aws\credentials.&nbsp;</p><p>Then, you need to add these profiles:</p><pre class="prettyprint"><code class="language-js"><br /><p>[dev]</p><p>role_arn = arn:aws:iam::#account_number#:role/#YourRole#</p><p>source_profile = mfa</p><p>[mfa]</p><p>aws_access_key_id = #aws_access_key_id_from_get-session-token_command#</p><p>aws_secret_access_key = #aws_secret_access_key_from_get-session-token_command#</p><p>aws_session_token = #aws_session_token_from_get-session-token_command#</p><br /></code></pre><p>So basically, when you use [dev] profile, it will assume the role you configured using the credentials that you setup in [mfa].</p><h3 style="text-align: left;">Configure pulumi or other applications</h3><p>In order to use your profile in pulumi, in the stack folder, you need to run this command:</p><p style="text-align: center;"><span style="font-family: courier;">pulumi config set aws:profile dev</span></p><p>For console commands or other local tools, setup your environment variable properly with PowerShell or CMD bash (*):</p><p style="text-align: center;"><span style="font-family: courier;">setx AWS_PROFILE dev</span></p><p>(*) To apply the change when you update an environment variable, you need to reset your terminal.</p><h2 style="text-align: left;">Automating credentials refresh with PowerShell</h2><p>This process is quite straightforward, but it can be a little annoying if you have to perform those manual steps each time you want to refresh your credentials.&nbsp;</p><p>In order to make this process really easy, I've created a PowerShell script, which will request your MFA code and it will refresh your profile with those credentials.&nbsp;</p><pre class="prettyprint"><code class="language-js"><p>$MfaDeviceArn = "#YOUR_MFA_DEVICE_ARN#"</p><p>$DurationInSeconds = 28800</p><p>$OpsProfileName = "ops"</p><p>$MfaProfileName = "mfadev"</p><p><br /></p><p>$MfaCode = Read-Host -Prompt 'Please, input your MFA code'</p><p><br /></p><p>$TempCredentials = aws sts get-session-token --duration-seconds $DurationInSeconds --serial-number $MfaDeviceArn --token-code $MfaCode --profile $OpsProfileName&nbsp; | ConvertFrom-Json&nbsp;</p><p><br /></p><p>Write-Output "Updating your profile '$MfaProfileName' with your new temporary credentials..."</p><p><br /></p><p>$AccessKeyId = ($TempCredentials).Credentials.AccessKeyId</p><p>$SecretAccessKey = ($TempCredentials).Credentials.SecretAccessKey</p><p>$SessionToken = ($TempCredentials).Credentials.SessionToken</p><p><br /></p><p>aws configure set aws_access_key_id $AccessKeyId --profile $MfaProfileName</p><p>aws configure set aws_secret_access_key $SecretAccessKey --profile $MfaProfileName</p><p>aws configure set aws_session_token $SessionToken --profile $MfaProfileName</p><p><br /></p><p>Write-Output "Profile '$MfaProfileName' updated successfully!"</p><p>Read-Host&nbsp; -Prompt "Press any key to continue or CTRL+C to quit"&nbsp;</p><p><br /></p></code></pre><p>So now, when we execute the script, I will request our MFA code and it will setup those credentials in our profile automatically.</p><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-PjqtVahQcmo/YRra9lMd_MI/AAAAAAAAGlI/mwnlmSqNxb8ta7Wf-6zLZTdFaVli3H0ZwCLcBGAsYHQ/s906/mfa.PNG" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="161" data-original-width="906" height="95" src="https://1.bp.blogspot.com/-PjqtVahQcmo/YRra9lMd_MI/AAAAAAAAGlI/mwnlmSqNxb8ta7Wf-6zLZTdFaVli3H0ZwCLcBGAsYHQ/w533-h95/mfa.PNG" width="533" /></a></div><br /><p>You can find the source code in this Git gist:&nbsp;<a href="https://gist.github.com/albertocorrales/f05c1f84554d20e3d32222964dcfaef0">https://gist.github.com/albertocorrales/f05c1f84554d20e3d32222964dcfaef0&nbsp;</a>.&nbsp;</p><p>I hope you found useful this article</p>